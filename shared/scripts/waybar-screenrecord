#!/bin/bash
# Waybar module for screen recording
# Outputs JSON for waybar, reacts instantly to state changes via inotifywait

PIDFILE="/tmp/screenrecord.pid"
STARTFILE="/tmp/screenrecord.start"

output() {
    if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
        local start
        start="$(cat "$STARTFILE" 2>/dev/null || echo "$(date +%s)")"
        local duration=$(( $(date +%s) - start ))
        printf '{"text": "● REC %ss", "tooltip": "Recording in progress (%ss)\\nClick or Super+R: stop", "class": "recording"}\n' "$duration" "$duration"
    else
        printf '{"text": "●", "tooltip": "Super+R: area | Super+Shift+R: screen | Super+Alt+R: window\\nClick: area | Right-click: screen | Middle-click: window", "class": "idle"}\n'
    fi
}

output

while true; do
    if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null; then
        # Recording active — update every second for the timer
        sleep 1
        output
    else
        # Idle — wait for pidfile to appear
        inotifywait -qq -e create -e modify -t 5 /tmp/ --include 'screenrecord\.pid' 2>/dev/null
        output
    fi
done
