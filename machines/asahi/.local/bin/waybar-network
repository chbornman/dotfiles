#!/bin/bash
# Network status for Waybar with lock state

LOG_FILE="/tmp/waybar-network.log"
LOCK_FILE="/tmp/wofi-menu.lock"
is_active=""

echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') - Script started" >> "$LOG_FILE"

if [ -f "$LOCK_FILE" ]; then
    lock_content=$(cat "$LOCK_FILE")
    echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') - Lock file exists with content: '$lock_content'" >> "$LOG_FILE"
    if [ "$lock_content" = "wifi" ]; then
        is_active="active"
        echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') - Setting is_active=active" >> "$LOG_FILE"
    fi
else
    echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') - Lock file does not exist" >> "$LOG_FILE"
fi

    # Get network info
    if nmcli -t -f active,ssid dev wifi | grep -q '^yes'; then
        essid=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d':' -f2)
        text="wifi $essid"
    elif nmcli -t -f DEVICE,TYPE,STATE device | grep -q ':ethernet:connected'; then
        ipaddr=$(nmcli -t -f DEVICE,TYPE,STATE,IP4 device | grep ':ethernet:connected' | cut -d':' -f4 | cut -d'/' -f1)
        text="eth $ipaddr"
    else
        text="wifi off"
    fi

# Output JSON for Waybar
if [ -n "$is_active" ]; then
    output="{\"text\":\"$text\",\"class\":\"active\",\"alt\":\"active\",\"percentage\":100}"
    echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') - Output (ACTIVE): $output" >> "$LOG_FILE"
    echo "$output"
else
    output="{\"text\":\"$text\",\"class\":\"\",\"alt\":\"\",\"percentage\":0}"
    echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') - Output (INACTIVE): $output" >> "$LOG_FILE"
    echo "$output"
fi
