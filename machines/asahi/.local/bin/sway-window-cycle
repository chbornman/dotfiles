#!/bin/bash
# Window switcher that cycles through windows in MRU order

# Get the currently focused window
current_id=$(swaymsg -t get_tree | jq '.. | select(.focused? == true) | .id')

# Get all windows (containers with app_id or class, excluding scratchpad)
windows=$(swaymsg -t get_tree | jq -r '
  .. | 
  select(.type? == "con") | 
  select(.app_id? != null or .class? != null) |
  select(.name? != null) |
  select(.pid? != null) |
  "\(.id)|\(.name)|\(.app_id // .class)|\(.workspace // "unknown")"
')

if [ -z "$windows" ]; then
    notify-send "Window Switcher" "No windows found" -u low
    exit 0
fi

# Build array of window IDs
readarray -t window_array <<< "$windows"

# Find current window index
current_index=-1
for i in "${!window_array[@]}"; do
    win_id=$(echo "${window_array[$i]}" | cut -d'|' -f1)
    if [ "$win_id" = "$current_id" ]; then
        current_index=$i
        break
    fi
done

# Get next window (cycle to beginning if at end)
if [ $current_index -eq -1 ]; then
    # No current window, focus first
    next_index=0
else
    next_index=$(( (current_index + 1) % ${#window_array[@]} ))
fi

# Get next window info
next_window="${window_array[$next_index]}"
next_id=$(echo "$next_window" | cut -d'|' -f1)
next_name=$(echo "$next_window" | cut -d'|' -f2)

# Focus the next window
swaymsg "[con_id=$next_id] focus"

# Show notification with window name
notify-send -t 1000 "Switched to" "$next_name" -u low
