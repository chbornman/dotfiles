#!/bin/bash
# Bluetooth device selector using wofi

LOCK_FILE="/tmp/wofi-menu.lock"

# Check if wofi is already running
if pgrep -x wofi > /dev/null; then
    # Check if it's the same menu
    if [ -f "$LOCK_FILE" ] && [ "$(cat "$LOCK_FILE")" = "bluetooth" ]; then
        # Same menu, close it
        pkill -x wofi
        rm -f "$LOCK_FILE"
        exit 0
    else
        # Different menu, close the old one
        pkill -x wofi
        rm -f "$LOCK_FILE"
        sleep 0.1
    fi
fi

# Mark this menu as open
echo "bluetooth" > "$LOCK_FILE"

# Check if bluetoothctl is available
if ! command -v bluetoothctl &> /dev/null; then
    notify-send "Bluetooth Menu" "bluetoothctl not found" -u critical
    exit 1
fi

# Get list of paired devices
paired_devices=$(bluetoothctl devices Paired | sed 's/Device //')

if [ -z "$paired_devices" ]; then
    notify-send "Bluetooth" "No paired devices found" -u normal
    exit 0
fi

# Separate connected from disconnected devices
connected_list=""
disconnected_list=""

while IFS= read -r line; do
    mac=$(echo "$line" | awk '{print $1}')
    name=$(echo "$line" | cut -d' ' -f2-)
    
    # Check if device is connected
    if bluetoothctl info "$mac" | grep -q "Connected: yes"; then
        connected_list+="[CONNECTED] $name|$mac\n"
    else
        disconnected_list+="$name|$mac\n"
    fi
done <<< "$paired_devices"

# Put connected devices at top
full_list="${connected_list}${disconnected_list}"

# Show in wofi (display name only)
selection=$(echo -e "$full_list" | sed 's/|.*//' | wofi --dmenu --width 400 --height 300 --location top_right --xoffset -10 --yoffset 40)

if [ -n "$selection" ]; then
    # Get MAC address from our list
    device_name=$(echo "$selection" | sed 's/\[CONNECTED\] //')
    mac=$(echo -e "$full_list" | grep "|" | grep "$device_name" | sed 's/.*|//')
    
    # Check if already connected
    if echo "$selection" | grep -q "\[CONNECTED\]"; then
        # Disconnect
        notify-send "Bluetooth" "Disconnecting $device_name..." -u low
        if bluetoothctl disconnect "$mac" &>/dev/null; then
            notify-send "Bluetooth" "Disconnected from $device_name" -u low
        else
            notify-send "Bluetooth" "Failed to disconnect from $device_name" -u critical
        fi
    else
        # Connect
        notify-send "Bluetooth" "Connecting to $device_name..." -u low
        if bluetoothctl connect "$mac" &>/dev/null; then
            notify-send "Bluetooth" "Connected to $device_name" -u low
        else
            notify-send "Bluetooth" "Failed to connect to $device_name" -u critical
        fi
    fi
fi

# Clean up lock file
rm -f "$LOCK_FILE"
