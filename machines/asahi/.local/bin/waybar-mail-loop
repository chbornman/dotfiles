#!/bin/bash
# Mail status for Waybar - event-driven

LOCK_DIR="/tmp"
PINNED_FILE="/tmp/waybar-menu-pinned"
MAIL_DIR="$HOME/.local/share/mail"

# Clean up all child processes on exit
cleanup() {
    pkill -P $$ 2>/dev/null
    kill $(jobs -p) 2>/dev/null
    wait 2>/dev/null
}
trap cleanup EXIT INT TERM HUP

output_status() {
    is_pinned=""
    
    if [ -f "$PINNED_FILE" ]; then
        pinned_content=$(cat "$PINNED_FILE")
        if [ "$pinned_content" = "mail" ]; then
            is_pinned="pinned"
        fi
    fi

    # Count unread mail (new messages in */INBOX/new/)
    unread=0
    if [ -d "$MAIL_DIR" ]; then
        unread=$(find "$MAIL_DIR" -path "*/INBOX/new/*" -type f 2>/dev/null | wc -l)
    fi

    ENVELOPE=$'\uf0e0'
    if [ "$unread" -gt 0 ]; then
        text="$ENVELOPE $unread"
    else
        text="$ENVELOPE"
    fi

    # Output JSON for Waybar
    if [ -n "$is_pinned" ]; then
        echo "{\"text\":\"$text\",\"class\":\"pinned\",\"alt\":\"pinned\",\"percentage\":100}"
    else
        echo "{\"text\":\"$text\",\"class\":\"\",\"alt\":\"normal\",\"percentage\":0}"
    fi
}

# Output initial state
output_status

# Watch for pin file changes
inotifywait -m -e create,delete,modify "$LOCK_DIR" 2>/dev/null | while read -r directory event filename; do
    if [ "$filename" = "waybar-menu-pinned" ]; then
        output_status
    fi
done &

# Watch for mail changes
if [ -d "$MAIL_DIR" ]; then
    inotifywait -m -r -e create,delete,moved_to,moved_from "$MAIL_DIR" 2>/dev/null | while read -r line; do
        output_status
    done &
fi

# Wait for any child to exit
wait
