#!/bin/bash
# Launch btop as a floating terminal window

LOCK_FILE="/tmp/wofi-menu.lock"

# Check if another menu is open (wofi or terminal menu)
if pgrep -x wofi > /dev/null || [ -f "$LOCK_FILE" ]; then
    # Check if it's the same terminal menu
    if [ -f "$LOCK_FILE" ] && [ "$(cat "$LOCK_FILE")" = "btop" ]; then
        # Same menu, close it
        hyprctl dispatch closewindow "title:^WAYBAR-MENU: btop"
        rm -f "$LOCK_FILE"
        exit 0
    else
        # Close any existing menu (wofi or terminal)
        pkill -x wofi 2>/dev/null
        hyprctl dispatch closewindow "title:^WAYBAR-MENU:" 2>/dev/null
        rm -f "$LOCK_FILE"
        sleep 0.05
    fi
fi

# Set up trap to clean up lock file when script exits
trap "rm -f '$LOCK_FILE'" EXIT

# Mark this menu as open
echo "btop" > "$LOCK_FILE"

sleep 0.05

# Launch btop in a floating window with special title prefix (larger size for btop)
foot --title='WAYBAR-MENU: btop' /usr/bin/btop &

# Wait for the window to appear
sleep 0.5

# Poll for window closure
while hyprctl clients -j | jq -e '.[] | select(.title | startswith("WAYBAR-MENU: btop"))' > /dev/null 2>&1; do
    sleep 0.5
done

# Script exits here, trap will clean up lock file
