#!/bin/bash
# WiFi network selector using wofi

LOCK_FILE="/tmp/wofi-menu.lock"

# Check if wofi is already running
if pgrep -x wofi > /dev/null; then
    # Check if it's the same menu
    if [ -f "$LOCK_FILE" ] && [ "$(cat "$LOCK_FILE")" = "wifi" ]; then
        # Same menu, close it
        pkill -x wofi
        rm -f "$LOCK_FILE"
        exit 0
    else
        # Different menu, close the old one
        pkill -x wofi
        rm -f "$LOCK_FILE"
        sleep 0.1
    fi
fi

# Mark this menu as open
echo "wifi" > "$LOCK_FILE"

# Check if nmcli is available
if ! command -v nmcli &> /dev/null; then
    notify-send "WiFi Menu" "nmcli not found" -u critical
    exit 1
fi

# Get current connected network
current_ssid=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d':' -f2)

# Get list of available networks (SSID, signal strength, security)
networks=$(nmcli -f SSID,SIGNAL,SECURITY device wifi list | tail -n +2)

if [ -z "$networks" ]; then
    notify-send "WiFi Menu" "No networks found" -u normal
    exit 0
fi

# Separate current network from others
network_list=""
current_item=""

while IFS= read -r line; do
    ssid=$(echo "$line" | awk '{print $1}')
    
    if [ "$ssid" = "$current_ssid" ]; then
        current_item="[CONNECTED] $line"
    else
        network_list+="$line\n"
    fi
done <<< "$networks"

# Put connected network at top, then sort others by signal
if [ -n "$current_item" ]; then
    sorted_others=$(echo -e "$network_list" | sort -k2 -rn)
    full_list="$current_item\n$sorted_others"
else
    full_list=$(echo -e "$network_list" | sort -k2 -rn)
fi

# Show in wofi
selection=$(echo -e "$full_list" | wofi --dmenu --width 500 --height 400)

if [ -n "$selection" ]; then
    # Extract SSID (first column, remove [CONNECTED] prefix if present)
    ssid=$(echo "$selection" | sed 's/\[CONNECTED\] //' | awk '{print $1}')
    
    # Check if network requires password
    security=$(echo "$selection" | awk '{print $3}')
    
    if [ "$security" != "--" ]; then
        # Network is secured, prompt for password
        password=$(wofi --dmenu --password --prompt "Password for $ssid" --width 400)
        
        if [ -n "$password" ]; then
            notify-send "WiFi" "Connecting to $ssid..." -u low
            if nmcli device wifi connect "$ssid" password "$password"; then
                notify-send "WiFi" "Connected to $ssid" -u low
            else
                notify-send "WiFi" "Failed to connect to $ssid" -u critical
            fi
        fi
    else
        # Open network
        notify-send "WiFi" "Connecting to $ssid..." -u low
        if nmcli device wifi connect "$ssid"; then
            notify-send "WiFi" "Connected to $ssid" -u low
        else
            notify-send "WiFi" "Failed to connect to $ssid" -u critical
        fi
    fi
fi

# Clean up lock file
rm -f "$LOCK_FILE"
